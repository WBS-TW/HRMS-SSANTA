# Step-by-step walkthrough on how to generate msp files from raw HRMS files  
<br>  

We first start with the raw data from the analysis of a standard and we want to generate a .msp file as a final file. The msp file is a file format developed by NIST to store mass spectral data. For more information, please see this [document](https://chemdata.nist.gov/dokuwiki/lib/exe/fetch.php?media=chemdata:nist17:nistms_ver23man.pdf).  
If compounds are analyzed using GC, then you have to include an __alkane mix__ to be able to calculate the retention time index (RI). In our lab, we use a mix consisting of C7-C40 alkanes. Ask Thanh for the alkane mix.
  
```{r diagramSpeclib, echo=FALSE, fig.cap= "General workflow for spectral library", fig.align='center'}

# Diagrammer: rich-iannone.github.io/DiagrammeR/graphviz_and_mermaid.html

DiagrammeR::grViz("
digraph Scheme {
      
# graph statement
graph [layout = dot, overlap = false, rankdir = TB]

# node statements
node [shape = box]

A [label = 'Analysis of standard \\n using LC-HRMS or GC-HRMS.', fontsize = 24]

B [label = 'Convert raw data from \\n vendor format to mzML file format', fontsize = 24]

C [label = 'Fill in compound and \\n method information in template', fontsize = 24]

D [label = 'Use MD-DIAL to perform spectral \\n deconvolution and generate \\n spectra for each compound', fontsize = 24]

E [label = 'Export the spectra to MS-FINDER \\n to annotate spectral peaks', fontsize = 24]

F [label = 'Export final spectra to msp format', fontsize = 24]
      
      
# edge statements
edge [color = black]
A -> {B}
B -> {C}
C -> {D}
D -> {E}
E -> {F}

      
      }
      ")


```
  
  
The template folder for the spectral library is organized as follows:  


```{}
MTM_HRMS_LIB
│   MTMxxxxx_GC-EI-FT_POSITIVE.xlsx
|   MTMxxxxx_LC-ESI-QTOF_POSITIVE.xlsx
│   ..
└───0_Main_Lib
│   │   MTM_HRMS_MAINLIB.xlsx
│   │   ..
│   
└───1_Standard_infosheets
│   │   MTM00001_GC-EI-FT_POSITIVE.xlsx
│   │   MTM00002_GC-EI-FT_POSITIVE.xlsx
|   |   ..
│
└───2_mzML_data
│   └───GC_CI_NEG_HRMS
│   └───GC_CI_POS_HRMS
│   └───GC_EI_HRMS
|   └───LC_ESI_NEG_HRMS
│   └───LC_ESI_POS_HRMS
|
└───3_MSP
│   │   MTM00001_GC-EI-FT_POSITIVE_IASLDLGGHXYCEO-HWKANZROSA-N.msp
│   │   MTM00002_GC-EI-FT_POSITIVE_UPMLOUAZCHDJJD-UHFFFAOYSA-N.msp
│   │   ..
│
└───4_Massbank
│   │   MTM00001.txt
|   |   MTM00002.txt
|   |   ..
│
└───MSDIAL_PROJECT
|   └───MSDIAL_params
|   
└───R
    |   MTM_HRMS_database.Rmd
    
```
  
The main folder (MTM_HRMS_LIB) contain some template information sheet that are used to fill in information about the standard and the analysis method. The MTM id number (MTMxxxxx) for each standard infosheet is in numeric order and check the MTM_HRMS_MAINLIB.xlsx for the latest id number and use the subsequent one as the new MTM id. 

__INSTALL REQUIRED SOFTWARE__
  
Several software and packages are needed to generate the spectra library. All are open access and free to use for academic purposes.
  
Proteowizard: We mainly use MSConvert which is bundled in the Proteowizard software package and you can download it [here](http://proteowizard.sourceforge.net/download.html).  
MS-DIAL: used to analyze the mzML file and generate spectra. Download the latest version [here](http://prime.psc.riken.jp/compms/msdial/main.html). No installation is necessary so you only need to extract the downloaded zip file to your folder of choice.  
MS-FINDER: used to annotate the individual peaks in the spectrum and export to msp file.  
  
## Analyzing the standards using HRMS  
It is recommended to analyze single standards but mixtures are also feasible to analyze if the analytes are not coeluting too close to each other. The deconvolution algorithm of MS-DIAL is able to distinguish between two peaks that are closely eluted but still have slightly different retention times.  
You should also inject a _solvent blank_ to perform blank subtraction later in MS-DIAL.  
  
  
## Convert the raw data file from GC-HRMS analysis to .mzML using MSconvert (For unifi conversion, see section XX)  
<br>  
The first step is to convert the vendor software format to the open mass spectrometric data format mzML. We use MSConvert to perform this. After installation, open the MSConvert program.
Most vendor software record the mass spectra in profile mode, but data processing of this is usually very time consuming as well as producing a very large file. Therefore, during file conversion we also perform centroiding to make downstream data processing easier as well as reducing the size of the mzML file. 1. Click "Browse" and choose the raw files you want to include and "add" these.  
2. Choose mzML as the output format.  Make sure the "Output Directory" is correctly set to the folder you want to store the mzML file. For this library task, you can directly choose the "/MTM_HRMS_LIB/MSDIAL_PROJECT" in the library folder as temporary storage.  
3. In the "Filters" dropdown menu, select the "Peak Picking. For "Algorithm", use "Vendor" for most raw files. Choose appropriate MS Levels you want to include. Use "1 - " to choose all MS levels. For GC data, this is fine. Press add and then make sure to move the "peakPicking" filter as the first filter as seen in below figure. 
4. If you have many files, it would be wise to increase the "Files to convert in parallel" to speed up the process. However, this depends on your computer processing power the number of cores it has. The other parameters should be set as seen in below Figure \@ref(fig:MSConvert).  

```{r MSConvert, echo = FALSE, fig.cap= "MSConvert"}

knitr::include_graphics("images/MSConvert.png", dpi = 100)
```

Now you can proceed with the conversion by clicking "Start".    
After you have finished with the conversion, copy the mzML file(s) to the designated folder in MTM_HRMS_LIB/2_mzML_data/../ (where ".." is the folder depending on your instrument type and analysis mode).


## Fill in the standard infosheet
  
In the main folder, choose one of the standard information sheets depending on whether you used LC or GC and the ionization mode. The content of the information sheet looks slightly different depending on LC or GC. Copy the chosen infosheet to the "1_Standard_infosheets" folder. In that folder, rename the copied infosheet to the new MTM id as mentioned in previous section.  
The infosheet is organized in accordance to the format used by [Massbank Europe](https://massbank.eu//MassBank/). A description on the Massbank record format can be found [here](https://github.com/MassBank/MassBank-web/blob/main/Documentation/MassBankRecordFormat.md). It is important that you do not change any of the titles in the first column in the infosheet, as the format requirement is quite strict. Also, try not to copy text from one cell to another as it might change the underlying format of the cells (if you think you made an error, copy the template and redo again).  
The rows that are in bold are information that are mandatory to fill in. The "ACCESSION" row is the MTM id, the "RECORD_TITLE" will be automatically generated based on the information you filled in so you will not fill this row.  
"COMMENT: centroided mzML file name" is for internal purposes and refers to the name of the mzML file you converted.  
"COMMENT: msp file name" is automatically generated and will be used later to name the msp file.  
"COMMENT: CONFIDENCE" refers to how confident you are of the identification of your standard according to the ["Schymanski scale"](https://pubs.acs.org/doi/abs/10.1021/es5002105). Leave it as "Reference Standard (Level 1)", unless there are standards where you cannot distinguish or identify between different isomers in a standard. In this case, you should use "Level 3". An example is "Technical mixture (Level 3)".  
"CH\$NAME:" occurs twice which means you have to input two different names for the compound in the standard, because a compound can have different names. It could be the common name specified in PubChem, the IUPAC name, trade name or the abbreviation.  
The "CH\$IUPAC" is the InChI which starts with "InChI=". You can find all these information for the compound by searching in [PubChem](https://pubchem.ncbi.nlm.nih.gov/).  
For GC compounds, you also need to fill in the "AC\$CHROMATOGRAPHY: KOVATS_RTI" and "AC\$CHROMATOGRAPHY: RETENTION_TIME". These will be available later in MS-DIAL.
  
The other rows should be quite straightforward to fill in. If you use the same method for many standards, then you can save a copy of an infosheet to use as a method template, while only filling information for the different compounds: ACCESSION, DATE, COMMENT: centroided mzML file name, CH\$NAME, CH\$NAME, CH\$FORMULA:, CH\$EXACT_MASS:, CH\$SMILES:, CH\$IUPAC:, CH\$LINK: CAS, CH\$LINK: INCHIKEY 
  
Now that you have filled in most information about the compound, we can proceed to process the mzML file to extract the spectra using MS-DIAL (although you can also first process the mzML files and then fill in the information afterwards).
  

## Use MD-DIAL to perform spectral deconvolution and generate spectra for each compound
  
The graphical layout of MS-DIAL takes some time to get used to since it is centered around detected peaks. It is important that you choose the correct parameters in the beginning since the parameters can affect the peak detection and alignment, or else you need to redo the data preprocessing again which could take long time if you are analyzing a lot of samples. In the case where we analyze standards, then the default parameters with some instrument specific parameters can be used. These are found in the subfolder _MSDIAL_PROJECT/MSDIAL_params/_. If you want to know more details about data processing using MS-DIAL, please check the [online tutorial](https://mtbinfo-team.github.io/mtbinfo.github.io/MS-DIAL/tutorial.html). 
  
The below steps are based on the excellent workflow for GC-EI orbitrap data described by [Price et al.](https://www.frontiersin.org/articles/10.3389/fpubh.2021.622558/full):  
1. In the File menu, start a new project. You must choose a file path where the mzML file(s) are located. When the data analysis is finished, several files associated with the analysis is created in the same folder. Depending on GC or LC analysis, then different parameters needs to be selected. Below Figure \@ref(fig:MSConvertStartup) shows parameters for GC analysis. GC-EI is a hard ionization and we also centroided the mzML file so these paramters needs to be specified.  

```{r MSConvertStartup, echo = FALSE, fig.cap= "Starting a new project for GC analysis"}

knitr::include_graphics("images/chap15/MSDIAL_startproject.png", dpi = 100)
```
  
Click on the "Advanced: add further meta data" tab. The information for different instruments in our lab can be found in the file "/MTM_HRMS_LIB/MSDIAL_PROJECT/MSDIAL_params/Metadata.txt". If your instrument is not present then you can input these by yourself. This metadata is optional but the information will be added to the msp file later.  
When you are finished, click on next.  

2. Click on the browse button and then you will select the files to process. The default file format is .abf but we want to process .mzML so choose this file format instead. You will now see the mzML file(s) in your working directory. If you want to process multiple files use _Shift/Ctrl + select_. Make sure your standards are designated as "Sample". You should include a solvent blank which will be designated as "Blank". The pther columns are for post processing and not important for this spectral database workflow. You can learn more about these in the [tutorial](https://mtbinfo-team.github.io/mtbinfo.github.io/MS-DIAL/tutorial.html).  

```{r MSConvertChoosefiles, echo = FALSE, fig.cap= "Choosing files"}

knitr::include_graphics("images/chap15/MSDIAL_choosefiles.png", dpi = 100)
```

Click on next to the Analysis parameter settings.
  
3. The following instructions are for GC-EI orbitrap data, but the other processing methods are similar. Click on the "Load" button and select the "GC_EI_Orbitrap.med2" (for GC-EI-orbtrap files) file located in the "/MTM_HRMS_LIB/MSDIAL_PROJECT/MSDIAL_params/" folder. This will load the preset parameters for this instrument. You can set the parameters that are suitable for your specific analysis. Click on the "Advanced" tab and you can also choose how many samples (threads) to process in parallel. Continue with the "Peak detection" tab and set an appropriate minimum peak height. This is instrument specific and also depends on the concentration of the analytes. If the "Accurate MS" box is not checked, then select it. Below Figure \@ref(fig:MSConvertPeakdetection) shows the parameters for the GC-EI orbitrap. The smoothing levels and width can be set as 3 and 10 respectively for GC analysis. 


```{r MSConvertPeakdetection, echo = FALSE, fig.cap= "Peak detection parameters"}

knitr::include_graphics("images/chap15/MSDIAL_peakdetection.png", dpi = 100)
```
  
Continue to the "MS1Dec" tab.
  
4. The sigma window value is an important parameter which determines the efficiency of the deconvolution algorithm. The parameter depends on the instrument and Figure \@ref(fig:MSConvertMS1Dec) shows the recommened ones for the GC orbitrap analysis of standards. From the [online tutorial](https://mtbinfo-team.github.io/mtbinfo.github.io/MS-DIAL/tutorial.html#chapter-4): "The sigma window value is highly affected by the resolution of deconvolutions. A higher value (0.7-1.0) will reduce the peak top resolutions, i.e. the number of resolved chromatographic peaks will be decreased. On the other hand, a lower value (0.1-0.3) may also recognize many noise chromatographic peaks. In addition, you may set a cutoff value to reduce the MS noises (see Section 3-3 of Chapter 3). This is the same as LC/MS part."


```{r MSConvertMS1Dec, echo = FALSE, fig.cap= "MS1Dec parameters"}

knitr::include_graphics("images/chap15/MSDIAL_MS1Dec.png", dpi = 100)
```
  

Continue to the "Identification" tab. 
  
5. If you process GC data, we mainly want to "Use retention index (RI)". If the below "Set" button cannot be clicked, then first click on the "Use retention time (min)" button and the back again to the "Use retention index (RI)" button and then you will be able to click on the "Set" button next to the Index file (Figure \@ref(fig:MSConverIdentification)). The "Index type" should be set to "Alkanes" since we analyzed the alkane mix. If you are using LC, then you should choose "Use retention time (min)". After you clicked the Set button, you will then choose a retention index file that include the retention time (in minutes) of the different alkanes in the mixture. A template of how the format should be can be found in the file "/MTM_HRMS_LIB/MSDIAL_PROJECT/MSDIAL_params/xxxxxx_RTI_MSDIAL.txt". Adjust the retention time depending on your specific analysis after checking the chromatogram of the alkane mix. An example of the retention times of alkane mix can be found in the "AlkaneMixRT.pptx" file. After you chosen the RTI file, right click on the other rows and choose autofill.
  

```{r MSConverIdentification, echo = FALSE, fig.cap= "Identification parameters"}

knitr::include_graphics("images/chap15/MSDIAL_identification.png", dpi = 100)
```
  

The other parameters are not important in this workflow and you can click on the "Alignment" tab. The purpose of alignment is to align all individual samples so the retention times for the same for the same compound between all samples. This is because the chromatographic separation will change between runs and batches and needs to be aligned. You do not need to pay attention to this tab for the spectral library purpose. continue to the last tab "Filtering".
  
Select the "Remove features based on blank information"and choose 5 fold change. This will remove any features that are lower than five times the blank samples (solvent blank in this case).  


```{r MSConverFiltering, echo = FALSE, fig.cap= "Filtering parameters"}

knitr::include_graphics("images/chap15/MSDIAL_filtering.png", dpi = 100)
```
  
Now you are done and click on "Finish".  




